<!DOCTYPE html>
<html>
	<head>
		<!-- load styles -->
		<style>{{d3css}}</style>
		<style>{{css}}</style>

		<!-- load javascript -->
		<script type='text/javascript'>{{js}}</script>


		<script type='text/javascript'>

			{{d3js}}

			function updateSharedParameters(){
				shared_params = "";
				{% for field in shared_fields %}
					var {{field['variable_name']}} = $("#{{field['variable_name']}}").val();
					shared_params = shared_params+"{{field['variable_name']}}="+{{field['variable_name']}}+"&";
					console.log(shared_params)
				{% endfor %}
			}

			{% for control in controls %}

				{% if control['output_type']=='image' %}
					// function to load image
					function {{control['control_name']}}(){
						$("#{{control['control_name']}}").empty();
						updateSharedParameters()
						var  params = "";
						{% for field in control['text_fields'] %}
							var {{field['variable_name']}} = $("#{{field['variable_name']}}").val();
							params = params+"{{field['variable_name']}}="+{{field['variable_name']}}+"&"
						{% endfor %}
						params = params+shared_params;
						console.log(params);
						var plot = $("<img />").attr('src', "/plot?"+params)
						$("#{{control['control_name']}}").append(plot);
					}
				{% endif %}

				// load custom html
				{% if control['output_type']=='html' %}
					
					// function to load image
					function {{control['control_name']}}(){
						$("#custom_html").empty();
						updateSharedParameters()
						var  params = "";
						{% for field in control['text_fields'] %}
							var {{field['variable_name']}} = $("#{{field['variable_name']}}").val();
							params = params+"{{field['variable_name']}}="+{{field['variable_name']}}+"&"
						{% endfor %}
						params = params+shared_params;
						$.ajax({
							url : "/html?"+params,
							success: function(response, textStatus, jqXHR){
								console.log(response);
								var html = response;
								$("#custom_html").append(html);
							}
						});
					}
				{% endif %}


				{% if control['output_type']=='d3' %}
					function show_d3_plot(){
						$("#chart").empty();
						updateSharedParameters()
						var  params = "";
						{% for field in control['text_fields'] %}
							var {{field['variable_name']}} = $("#{{field['variable_name']}}").val();
							params = params+"{{field['variable_name']}}="+{{field['variable_name']}}+"&"
						{% endfor %}
						params = params+shared_params;
						$.ajax({
							url : "/data?"+params,
							success: function(response, textStatus, jqXHR)
							{
								var data = response.data;
								console.log(data);
								draw(data);
							}
						});
					}
				{% endif %}

				{% if control['output_type']=='table' %}
					function show_table(){
						updateSharedParameters()
						var  params = "";
						{% for field in control['text_fields'] %}
							var {{field['variable_name']}} = $("#{{field['variable_name']}}").val();
							params = params+"{{field['variable_name']}}="+{{field['variable_name']}}+"&"
						{% endfor %}
						params = params+shared_params;
						sortable = document.getElementById('sortable');
						$.ajax({
							url : "/data?"+params,
							success: function(response, textStatus, jqXHR){
								$(".sortable").empty();
								th = document.createElement('thead');
								tb = document.createElement('tbody');
								data = response['data'];
								console.log(data)
								keys = Object.keys(data[0]);
								console.log(keys);
								if (data.length > 0){
									var tr = document.createElement('tr');
									for (var i = 0; i<keys.length; i++) {
										var td = document.createElement('td');
										var text = document.createTextNode(keys[i]);
										td.appendChild(text);
										tr.appendChild(td);
									}
									th.appendChild(tr);
									sortable.appendChild(th);

									for(var j = 0; j < data.length; j++) {
										var tr = document.createElement('tr');
										for (var i = 0; i < keys.length; i++) {
											var td = document.createElement('td');
											var text = document.createTextNode(data[j][keys[i]]);
											td.appendChild(text);
											tr.appendChild(td);
										}
										tb.appendChild(tr)
									}
								}
								sortable.appendChild(tb);
								forEach(document.getElementsByTagName('table'), function(table) {
							      if (table.className.search(/\bsortable\b/) != -1) {
							      	console.log("hello");
							        sorttable.makeSortable(table);
							      }
							    });
							}
							
						});
					}
				{% endif %}
			{% endfor %}
			
			$(document).ready(function() {

				{% for control in controls %}

					{% if control['output_type']=='image' %}
						// connect output to button
						$("#{{control['button_id']}}").click(function(e) {
							{{control['control_name']}}()
						});

						// if on_page_load is true, load when page loads
						{% if control['on_page_load']=='true' %}
							{{control['control_name']}}()
						{% endif %}
					{% endif %}

					// load custom html
					{% if control['output_type']=='html' %}
						// if on_page_load is true, load when page loads
						{% if control['on_page_load']=='true' %}
							{{control['control_name']}}()
						{% endif %}
					{% endif %}


					{% if control['output_type']=='d3' %}
						// connect output to button
						$("#{{control['button_id']}}").click(function(e) {
							show_d3_plot()
						});

						// if on_page_load is true, load when page loads
						{% if control['on_page_load']=='true' %}
							show_d3_plot()
						{% endif %}

					{% endif %}

					{% if control['output_type']=='table' %}
						// connect output to button
						$("#{{control['button_id']}}").click(function(e) {
							show_table()
						});

						// if on_page_load is true, load when page loads
						{% if control['on_page_load']=='true' %}
							show_table()
						{% endif %}
					{% endif %}
				{% endfor %}
			});
		</script>
	</head>
	<body>
		<div class="outer">
		<h1>{{title}}</h1>

		<!-- control panel -->
		<div class="left-panel">
			{% for field in shared_fields %}
				{{field['label']}}: <input type="{{field['input_type']}}" value="{{field['value']}}" id="{{field['variable_name']}}" /><br>
			{% endfor %}
			{% for control in controls %}
				{% for field in control['text_fields'] %}
					{{field['label']}}: <input type="{{field['input_type']}}" value="{{field['value']}}" id="{{field['variable_name']}}" /><br>
				{% endfor %}

				<!-- buttons -->
				{% if control['control_type']=="button" %}
					<div class="button" id="{{control['button_id']}}" onclick="{{control['control_name']}}()">{{control['button_label']}}</div><br>
				{% endif %}


			{% endfor %}
		</div>

		<!-- output -->
		<div class="right-panel">
			<!-- custom html -->
			<div id="custom_html"></div>

			<!-- images -->
			{% for control in controls %}
				{% if control['output_type'] != "table" and control['output_type'] != "d3" %}
					<div id="{{control['control_name']}}"></div>
				{% endif %}
			{% endfor %}

			<!-- d3 figs go here -->
			<div id="chart"></div>

			<!-- tables go here -->
	        <table class="sortable" id="sortable">
				<thead></thead>
				<tbody></tbody>
			</table>
		</div>
		</div>
		
	</body>
</html>

